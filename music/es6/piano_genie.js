!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e(require("@tensorflow/tfjs")):"function"==typeof define&&define.amd?define(["tf"],e):"object"==typeof exports?exports.piano_genie=e(require("@tensorflow/tfjs")):t.piano_genie=e(t.tf)}(self,(function(t){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=74)}({0:function(e,n){e.exports=t},6:function(t,e,n){"use strict";(function(t){n.d(e,"a",(function(){return s})),n.d(e,"d",(function(){return o})),n.d(e,"c",(function(){return r})),n.d(e,"b",(function(){return c}));const i=function(){if("undefined"!=typeof globalThis)return globalThis;if("undefined"!=typeof self)return self;if("undefined"!=typeof window)return window;if(void 0!==t)return t;throw new Error("cannot find the global object")}(),s=i.fetch.bind(i),o=i.performance,r=(i.navigator,!!i.webkitOfflineAudioContext),a=void 0!==i.WorkerGlobalScope;function c(t){if(t=r?44100:t,a)throw new Error("Cannot use offline audio context in a web worker.");const e=i.webkitOfflineAudioContext;return r?new e(1,t,t):new i.OfflineAudioContext(1,t,t)}}).call(this,n(9))},74:function(t,e,n){"use strict";n.r(e),n.d(e,"PianoGenie",(function(){return p})),n.d(e,"PianoGenieKeysig",(function(){return y})),n.d(e,"PianoGenieChord",(function(){return m})),n.d(e,"PianoGenieKeysigChordFamily",(function(){return b})),n.d(e,"PianoGenieKeysigChord",(function(){return S}));var i=n(0),s=n(6);function o(t){for(let e=0;e<2;++e)t.c[e].dispose(),t.h[e].dispose()}function r(t,e,n){if((e=void 0!==e?e:1)<0||e>1)throw new Error("Invalid temperature specified");let s;if(0===e)s=i.argMax(t,0);else{e<1&&(t=i.div(t,i.scalar(e,"float32")));const o=i.reshape(i.softmax(t,0),[1,-1]),r=i.multinomial(o,1,n,!0);s=i.reshape(r,[])}return s}class a extends class{constructor(t){this.checkpointURL=t,this.initialized=!1}isInitialized(){return this.initialized}async initialize(t){if(this.initialized&&this.dispose(),void 0===this.checkpointURL&&void 0===t)throw new Error("Need to specify either URI or static variables");if(void 0===t){const t=await Object(s.a)(this.checkpointURL+"/weights_manifest.json").then(t=>t.json()).then(t=>i.io.loadWeights(t,this.checkpointURL));this.modelVars=t}else this.modelVars=t;this.decLSTMCells=[],this.decForgetBias=i.scalar(1,"float32");for(let t=0;t<2;++t){const e=`phero_model/decoder/rnn/rnn/multi_rnn_cell/cell_${t}/lstm_cell/`;this.decLSTMCells.push((t,n,s)=>i.basicLSTMCell(this.decForgetBias,this.modelVars[e+"kernel"],this.modelVars[e+"bias"],t,n,s))}this.resetState(),this.initialized=!0,this.next(0),this.resetState()}getRnnInputFeats(){return i.tidy(()=>{const t=i.tensor1d([this.button],"float32");return i.sub(i.mul(2,i.div(t,7)),1).as1D()})}next(t,e,n){return this.nextWithCustomSamplingFunction(t,t=>r(t,e,n))}nextFromKeyWhitelist(t,e,n,s){return this.nextWithCustomSamplingFunction(t,t=>{const o=i.tensor1d(e,"int32");let a=r(t=i.gather(t,o),n,s);const c=i.gather(o,i.reshape(a,[1]));return a=i.reshape(c,[]),a})}nextWithCustomSamplingFunction(t,e){const n=this.lastState;this.button=t;const i=this.getRnnInputFeats(),[s,r]=this.evaluateModelAndSample(i,n,e);return i.dispose(),o(this.lastState),this.lastState=s,r}evaluateModelAndSample(t,e,n){if(!this.initialized)throw new Error("Model is not initialized.");const[s,o]=i.tidy(()=>{let s=i.matMul(i.expandDims(t,0),this.modelVars["phero_model/decoder/rnn_input/dense/kernel"]);s=i.add(s,this.modelVars["phero_model/decoder/rnn_input/dense/bias"]);const[o,r]=i.multiRNNCell(this.decLSTMCells,s,e.c,e.h),a={c:o,h:r};let c=i.matMul(r[1],this.modelVars["phero_model/decoder/pitches/dense/kernel"]);c=i.add(c,this.modelVars["phero_model/decoder/pitches/dense/bias"]);const l=i.reshape(c,[88]);return[a,n(l).dataSync()[0]]});return[s,o]}resetState(){void 0!==this.lastState&&o(this.lastState),this.lastState=function(){const t={c:[],h:[]};for(let e=0;e<2;++e)t.c.push(i.zeros([1,128],"float32")),t.h.push(i.zeros([1,128],"float32"));return t}()}dispose(){this.initialized&&(Object.keys(this.modelVars).forEach(t=>this.modelVars[t].dispose()),this.decForgetBias.dispose(),o(this.lastState),this.initialized=!1)}}{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=this.lastOutput,n=this.lastTime,s=this.time;let o;void 0===this.deltaTimeOverride?o=(s.getTime()-n.getTime())/1e3:(o=this.deltaTimeOverride,this.deltaTimeOverride=void 0);const r=i.scalar(e,"int32"),a=i.addStrict(r,i.scalar(1,"int32")),c=i.cast(i.oneHot(a,89),"float32");t.push(c);const l=i.scalar(o,"float32"),u=i.round(i.mul(l,31.25)),d=i.minimum(u,32),h=i.cast(i.add(d,1e-4),"int32"),f=i.oneHot(h,33),p=i.cast(f,"float32");return t.push(p),this.lastTime=s,i.concat1d(t)})}nextWithCustomSamplingFunction(t,e){this.time=new Date;const n=super.nextWithCustomSamplingFunction(t,e);return this.lastOutput=n,this.lastTime=this.time,n}overrideLastOutput(t){this.lastOutput=t}overrideDeltaTime(t){this.deltaTimeOverride=t}resetState(){super.resetState(),this.lastOutput=-1,this.lastTime=new Date,this.lastTime.setSeconds(this.lastTime.getSeconds()-1e5),this.time=new Date}}var c,l;!function(t){t[t.None=0]="None",t[t.C=1]="C",t[t.Cs=2]="Cs",t[t.D=3]="D",t[t.Eb=4]="Eb",t[t.E=5]="E",t[t.F=6]="F",t[t.Fs=7]="Fs",t[t.G=8]="G",t[t.Ab=9]="Ab",t[t.A=10]="A",t[t.Bb=11]="Bb",t[t.B=12]="B"}(c||(c={})),function(t){t[t.None=0]="None",t[t.Maj=1]="Maj",t[t.Min=2]="Min",t[t.Aug=3]="Aug",t[t.Dim=4]="Dim",t[t.Seven=5]="Seven",t[t.Maj7=6]="Maj7",t[t.Min7=7]="Min7",t[t.Min7b5=8]="Min7b5"}(l||(l={}));class u extends a{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.chordRoot,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,12),"float32");t.push(s);const o=i.scalar(this.chordFamily,"int32"),r=i.subStrict(o,i.scalar(1,"int32")),a=i.cast(i.oneHot(r,8),"float32");return t.push(a),i.concat1d(t)})}setChordRoot(t){this.chordRoot=t}setChordFamily(t){this.chordFamily=t}resetState(){super.resetState(),this.chordRoot=c.None,this.chordFamily=l.None}}class d extends a{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.keySignature,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,12),"float32");return t.push(s),i.concat1d(t)})}setKeySignature(t){this.keySignature=t}resetState(){super.resetState(),this.keySignature=c.None}}class h extends d{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.chordRoot,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,12),"float32");t.push(s);const o=i.scalar(this.chordFamily,"int32"),r=i.subStrict(o,i.scalar(1,"int32")),a=i.cast(i.oneHot(r,8),"float32");return t.push(a),i.concat1d(t)})}setChordRoot(t){this.chordRoot=t}setChordFamily(t){this.chordFamily=t}resetState(){super.resetState(),this.chordRoot=c.None,this.chordFamily=l.None}}class f extends d{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.chordFamily,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,8),"float32");return t.push(s),i.concat1d(t)})}setChordFamily(t){this.chordFamily=t}resetState(){super.resetState(),this.chordFamily=l.None}}class p extends a{}class m extends u{}class y extends d{}class S extends h{}class b extends f{}},9:function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n}})}));