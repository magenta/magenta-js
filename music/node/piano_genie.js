!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.mm=e():t.mm=e()}(global,(function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var s=e[i]={i,l:!1,exports:{}};return t[i].call(s.exports,s,s.exports,n),s.l=!0,s.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)n.d(i,s,function(e){return t[e]}.bind(null,s));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=33)}({0:function(t,e){t.exports=require("@tensorflow/tfjs")},15:function(t,e){t.exports=require("node-fetch")},16:function(t,e,n){"use strict";n.r(e),function(t){n.d(e,"now",(function(){return s})),n.d(e,"timing",(function(){return r}));const i=t.process.hrtime(),s=()=>{const e=t.process.hrtime(i);return e[0]+e[1]/1e9},r={navigationStart:Date.now()}}.call(this,n(17))},17:function(t,e){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(t){"object"==typeof window&&(n=window)}t.exports=n},18:function(t,e,n){"use strict";n.r(e),n.d(e,"userAgent",(function(){return i}));const i=""},33:function(t,e,n){"use strict";n.r(e),n.d(e,"PianoGenie",(function(){return f})),n.d(e,"PianoGenieKeysig",(function(){return S})),n.d(e,"PianoGenieChord",(function(){return m})),n.d(e,"PianoGenieKeysigChordFamily",(function(){return g})),n.d(e,"PianoGenieKeysigChord",(function(){return y}));var i=n(0),s=n(6);function r(t){for(let e=0;e<2;++e)t.c[e].dispose(),t.h[e].dispose()}function o(t,e,n){if((e=void 0!==e?e:1)<0||e>1)throw new Error("Invalid temperature specified");let s;if(0===e)s=i.argMax(t,0);else{e<1&&(t=i.div(t,i.scalar(e,"float32")));const r=i.reshape(i.softmax(t,0),[1,-1]),o=i.multinomial(r,1,n,!0);s=i.reshape(o,[])}return s}class a extends class{constructor(t){this.checkpointURL=t,this.initialized=!1}isInitialized(){return this.initialized}async initialize(t){if(this.initialized&&this.dispose(),void 0===this.checkpointURL&&void 0===t)throw new Error("Need to specify either URI or static variables");if(void 0===t){const t=await Object(s.a)(this.checkpointURL+"/weights_manifest.json").then(t=>t.json()).then(t=>i.io.loadWeights(t,this.checkpointURL));this.modelVars=t}else this.modelVars=t;this.decLSTMCells=[],this.decForgetBias=i.scalar(1,"float32");for(let t=0;t<2;++t){const e=`phero_model/decoder/rnn/rnn/multi_rnn_cell/cell_${t}/lstm_cell/`;this.decLSTMCells.push((t,n,s)=>i.basicLSTMCell(this.decForgetBias,this.modelVars[e+"kernel"],this.modelVars[e+"bias"],t,n,s))}this.resetState(),this.initialized=!0,this.next(0),this.resetState()}getRnnInputFeats(){return i.tidy(()=>{const t=i.tensor1d([this.button],"float32");return i.sub(i.mul(2,i.div(t,7)),1).as1D()})}next(t,e,n){return this.nextWithCustomSamplingFunction(t,t=>o(t,e,n))}nextFromKeyWhitelist(t,e,n,s){return this.nextWithCustomSamplingFunction(t,t=>{const r=i.tensor1d(e,"int32");let a=o(t=i.gather(t,r),n,s);const c=i.gather(r,i.reshape(a,[1]));return a=i.reshape(c,[]),a})}nextWithCustomSamplingFunction(t,e){const n=this.lastState;this.button=t;const i=this.getRnnInputFeats(),[s,o]=this.evaluateModelAndSample(i,n,e);return i.dispose(),r(this.lastState),this.lastState=s,o}evaluateModelAndSample(t,e,n){if(!this.initialized)throw new Error("Model is not initialized.");const[s,r]=i.tidy(()=>{let s=i.matMul(i.expandDims(t,0),this.modelVars["phero_model/decoder/rnn_input/dense/kernel"]);s=i.add(s,this.modelVars["phero_model/decoder/rnn_input/dense/bias"]);const[r,o]=i.multiRNNCell(this.decLSTMCells,s,e.c,e.h),a={c:r,h:o};let c=i.matMul(o[1],this.modelVars["phero_model/decoder/pitches/dense/kernel"]);c=i.add(c,this.modelVars["phero_model/decoder/pitches/dense/bias"]);const u=i.reshape(c,[88]);return[a,n(u).dataSync()[0]]});return[s,r]}resetState(){void 0!==this.lastState&&r(this.lastState),this.lastState=function(){const t={c:[],h:[]};for(let e=0;e<2;++e)t.c.push(i.zeros([1,128],"float32")),t.h.push(i.zeros([1,128],"float32"));return t}()}dispose(){this.initialized&&(Object.keys(this.modelVars).forEach(t=>this.modelVars[t].dispose()),this.decForgetBias.dispose(),r(this.lastState),this.initialized=!1)}}{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=this.lastOutput,n=this.lastTime,s=this.time;let r;void 0===this.deltaTimeOverride?r=(s.getTime()-n.getTime())/1e3:(r=this.deltaTimeOverride,this.deltaTimeOverride=void 0);const o=i.scalar(e,"int32"),a=i.addStrict(o,i.scalar(1,"int32")),c=i.cast(i.oneHot(a,89),"float32");t.push(c);const u=i.scalar(r,"float32"),l=i.round(i.mul(u,31.25)),d=i.minimum(l,32),h=i.cast(i.add(d,1e-4),"int32"),p=i.oneHot(h,33),f=i.cast(p,"float32");return t.push(f),this.lastTime=s,i.concat1d(t)})}nextWithCustomSamplingFunction(t,e){this.time=new Date;const n=super.nextWithCustomSamplingFunction(t,e);return this.lastOutput=n,this.lastTime=this.time,n}overrideLastOutput(t){this.lastOutput=t}overrideDeltaTime(t){this.deltaTimeOverride=t}resetState(){super.resetState(),this.lastOutput=-1,this.lastTime=new Date,this.lastTime.setSeconds(this.lastTime.getSeconds()-1e5),this.time=new Date}}var c,u;!function(t){t[t.None=0]="None",t[t.C=1]="C",t[t.Cs=2]="Cs",t[t.D=3]="D",t[t.Eb=4]="Eb",t[t.E=5]="E",t[t.F=6]="F",t[t.Fs=7]="Fs",t[t.G=8]="G",t[t.Ab=9]="Ab",t[t.A=10]="A",t[t.Bb=11]="Bb",t[t.B=12]="B"}(c||(c={})),function(t){t[t.None=0]="None",t[t.Maj=1]="Maj",t[t.Min=2]="Min",t[t.Aug=3]="Aug",t[t.Dim=4]="Dim",t[t.Seven=5]="Seven",t[t.Maj7=6]="Maj7",t[t.Min7=7]="Min7",t[t.Min7b5=8]="Min7b5"}(u||(u={}));class l extends a{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.chordRoot,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,12),"float32");t.push(s);const r=i.scalar(this.chordFamily,"int32"),o=i.subStrict(r,i.scalar(1,"int32")),a=i.cast(i.oneHot(o,8),"float32");return t.push(a),i.concat1d(t)})}setChordRoot(t){this.chordRoot=t}setChordFamily(t){this.chordFamily=t}resetState(){super.resetState(),this.chordRoot=c.None,this.chordFamily=u.None}}class d extends a{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.keySignature,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,12),"float32");return t.push(s),i.concat1d(t)})}setKeySignature(t){this.keySignature=t}resetState(){super.resetState(),this.keySignature=c.None}}class h extends d{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.chordRoot,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,12),"float32");t.push(s);const r=i.scalar(this.chordFamily,"int32"),o=i.subStrict(r,i.scalar(1,"int32")),a=i.cast(i.oneHot(o,8),"float32");return t.push(a),i.concat1d(t)})}setChordRoot(t){this.chordRoot=t}setChordFamily(t){this.chordFamily=t}resetState(){super.resetState(),this.chordRoot=c.None,this.chordFamily=u.None}}class p extends d{getRnnInputFeats(){return i.tidy(()=>{const t=[super.getRnnInputFeats()],e=i.scalar(this.chordFamily,"int32"),n=i.subStrict(e,i.scalar(1,"int32")),s=i.cast(i.oneHot(n,8),"float32");return t.push(s),i.concat1d(t)})}setChordFamily(t){this.chordFamily=t}resetState(){super.resetState(),this.chordFamily=u.None}}class f extends a{}class m extends l{}class S extends d{}class y extends h{}class g extends p{}},6:function(t,e,n){"use strict";n.d(e,"a",(function(){return i})),n.d(e,"d",(function(){return s})),n.d(e,"c",(function(){return r})),n.d(e,"b",(function(){return o}));const i=n(15),s=n(16);n(18);function r(){throw new Error("Cannot check if Safari in Node.js")}function o(t){throw new Error("Cannot use offline audio context in Node.js")}}})}));